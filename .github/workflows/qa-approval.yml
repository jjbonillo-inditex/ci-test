name: QA Approval Check

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number"
        required: true
        type: number

permissions:
  pull-requests: read
  checks: write

concurrency:
  group: qa-approval-${{ inputs.pr_number }}
  cancel-in-progress: true

jobs:
  qa-approval-check-in-progress:
    name: QA approval check in progress
    runs-on: ubuntu-latest

    steps:
      - name: Get PR head SHA
        id: get_sha
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Fetching head SHA for PR #${{ inputs.pr_number }}..."
          sha=$(gh api repos/${{ github.repository }}/pulls/${{ inputs.pr_number }} --jq '.head.sha')
          echo "sha=$sha" >> $GITHUB_OUTPUT

      - name: Clean Check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          existing_id=$(gh api repos/${{ github.repository }}/commits/"${{ steps.get_sha.outputs.sha }}"/check-runs \
            --jq '.check_runs[] | select(.name=="QA Approval") | .id' || true)
            
          if [[ -n "$existing_id" ]]; then
            echo "‚ö†Ô∏è Found existing check-run ($existing_id), marking as cancelled..."
            gh api \
              repos/${{ github.repository }}/check-runs/$existing_id \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              --input - <<EOF
              {
                "status": "completed",
                "conclusion": "cancelled",
                "output": {
                  "title": "Superseded run",
                  "summary": "Cancelled because a new QA check was triggered."
                }
              }
          EOF
          else
            echo "‚úÖ No previous check to clean."
          fi

      - name: Create QA check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üß© Creating QA check..."
          gh api repos/${{ github.repository }}/check-runs \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            --input - <<EOF
            {
              "name": "QA Approval",
              "head_sha": "${{ steps.get_sha.outputs.sha }}",
              "status": "in_progress",
              "output": {
                "title": "QA review in progress",
                "summary": "Waiting for QA approval result..."
              }
            }
          EOF

  detect_label:
    name: üè∑Ô∏è Detect QA Label
    runs-on: ubuntu-latest
    needs: qa-approval-check-in-progress
    outputs:
      qa_mode: ${{ steps.set_mode.outputs.qa_mode }}
    steps:
      - name: Determine QA mode
        env:
          GH_TOKEN: ${{ github.token }}
        id: set_mode
        run: |
          echo "üîç Checking labels on PR..."

          gh api repos/${{ github.repository }}/pulls/${{ inputs.pr_number }} > pr.json
          cat pr.json | jq '.labels[].name'

          labels=$(jq -r '.labels[].name' pr.json 2>/dev/null || echo "")

          echo "Labels found: $labels"

          if echo "$labels" | grep -q "\bqa\b"; then
          echo "qa_mode=enabled" >> $GITHUB_OUTPUT
          echo "‚úÖ QA label detected"
          elif echo "$labels" | grep -q "\bnoqa\b"; then
          echo "qa_mode=disabled" >> $GITHUB_OUTPUT
          echo "üö´ NOQA label detected"
          else
          echo "qa_mode=none" >> $GITHUB_OUTPUT
          echo "::error::‚ùå No valid label found ‚Äî failing workflow."
          fi

  qa-approval:
    name: QA approval required
    runs-on: ubuntu-latest
    needs: detect_label
    if: ${{ always() && needs.detect_label.result == 'success' }}
    outputs:
      approval_result: ${{ steps.set_result.outputs.approval_result }}

    steps:
      - name: Check QA approval status
        id: qa_enabled
        if: ${{ needs.detect_label.outputs.qa_mode == 'enabled' }}
        run: |
          echo "üîç Checking if @jujodevs has approved..."
          reviews=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ inputs.pr_number }}/reviews")
          
          last_state=$(echo "$reviews" | jq -r '[.[] | select(.user.login=="JuJoDevs")][-1].state // "NONE"')
          echo "üß© Last state: $last_state"

          if [[ "$last_state" == "APPROVED" ]]; then
            echo "‚úÖ QA approval detected."
            echo "approval_result=success" >> $GITHUB_OUTPUT
          else
            echo "::error::‚ùå QA approval required from @jujodevs."
            echo "approval_result=failure" >> $GITHUB_OUTPUT
          fi

      - name: QA not required
        id: qa_disabled
        if: ${{ needs.detect_label.outputs.qa_mode == 'disabled' }}
        run: |
          echo "‚úÖ QA not required ‚Äî skipping."
          echo "approval_result=success" >> $GITHUB_OUTPUT

      - name: NOQA label detected
        id: no_qa_label
        if: ${{ needs.detect_label.outputs.qa_mode == 'none' }}
        run: |
          echo "‚úÖ QA not required ‚Äî skipping."
          echo "approval_result=failure" >> $GITHUB_OUTPUT

      - name: Set result
        id: set_result
        run: |
          echo "approval_result=${{ steps.qa_enabled.outputs.approval_result || steps.qa_disabled.outputs.approval_result || steps.no_qa_label.outputs.approval_result }}" >> $GITHUB_OUTPUT

  qa-approval-check:
    name: QA approval check
    runs-on: ubuntu-latest
    needs: qa-approval
    if: ${{ always() && needs.qa-approval.result == 'success' }}

    steps:
      - name: Get PR head SHA
        id: get_sha
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Fetching head SHA for PR #${{ inputs.pr_number }}..."
          sha=$(gh api repos/${{ github.repository }}/pulls/${{ inputs.pr_number }} --jq '.head.sha')
          echo "sha=$sha" >> $GITHUB_OUTPUT

      - name: Send approval success check
        env:
          GH_TOKEN: ${{ github.token }}
        if: ${{ needs.qa-approval.outputs.approval_result == 'success' }}
        run: |
          gh api repos/${{ github.repository }}/check-runs \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            --input - <<EOF
            {
              "name": "QA Approval",
              "head_sha": "${{ steps.get_sha.outputs.sha }}",
              "status": "completed",
              "conclusion": "success",
              "output": {
                "title": "QA approved ‚úÖ",
                "summary": "PR approved by QA"
              }
            }
          EOF

      - name: Send approval failure check
        env:
          GH_TOKEN: ${{ github.token }}
        if: ${{ needs.qa-approval.outputs.approval_result == 'failure' || needs.qa-approval.outputs.approval_result == 'none' }}
        run: |
          gh api repos/${{ github.repository }}/check-runs \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            --input - <<EOF
            {
              "name": "QA Approval",
              "head_sha": "${{ steps.get_sha.outputs.sha }}",
              "status": "completed",
              "conclusion": "failure",
              "output": {
                "title": "QA approval required",
                "summary": "‚ùå QA approval check failed ‚Äî pending approval from QA"
              }
            }
          EOF
