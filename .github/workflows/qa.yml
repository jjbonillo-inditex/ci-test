name: Check QA Process

on:
  pull_request:
    types: [opened, reopened, labeled, unlabeled, synchronize]
  pull_request_review:
    types: [submitted, dismissed]

concurrency:
  group: qa-proccess-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  issues: write
  contents: read
  checks: write
env:
  QA: ${{ contains(github.event.pull_request.labels.*.name, 'qa') }}
  NOQA : ${{ contains(github.event.pull_request.labels.*.name, 'noqa') }}
jobs:
  detect_label:
    if: ${{ github.event_name == 'pull_request' }}
    name: ðŸ·ï¸ Detect QA Label
    runs-on: ubuntu-latest
    steps:
      - name: Add reviewer to PR
        if: ${{ env.QA == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ‘¤ Adding reviewer to PR..."

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          REVIEWER=JuJoDevs

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/requested_reviewers" \
            -d "{\"reviewers\":[\"$REVIEWER\"]}"

          echo "âœ… Reviewer @$REVIEWER added to PR #$PR_NUMBER"

      - name: Comment on PR to trigger mobile deploy
        if: ${{ env.QA == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ’¬ Waiting 10s before commenting (in case a new job starts)..."
          sleep 5
          echo "ðŸ’¬ Commenting '/deploy-mobile' on PR..."

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
            -d '{"body":"/deploy-mobile"}'

          echo "âœ… Comment '/deploy-mobile' added to PR #$PR_NUMBER"

      - name: Skip QA and continue
        if: ${{ env.NOQA == 'true' }}
        run: echo "ðŸš« QA mode disabled â€” continuing without QA verification"

      - name: Continue to QA Approval
        if: ${{ env.QA != 'true' && env.NOQA != 'true' }}
        run: |
          echo "âž¡ï¸ No QA labels detected â€” continuing to QA Approval step"
          exit 1

  qa-approval:
    name: QA approval
    runs-on: ubuntu-latest
    needs: detect_label
    steps:
      - name: Check QA approval status
        id: qa-review
        if: ${{ env.QA == 'true' }}
        run: |
          echo "ðŸ” Checking if @jujodevs has approved..."
          reviews=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews")

          last_state=$(echo "$reviews" | jq -r '[.[] | select(.user.login=="JuJoDevs")][-1].state // "NONE"')
          echo "ðŸ§© Last state: $last_state"

          if [[ "$last_state" == "APPROVED" ]]; then
            echo "âœ… QA approval detected."
            echo "approval=true" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ QA approval required from @jujodevs."
            echo "approval=false" >> $GITHUB_OUTPUT
          fi

      - name: Send approval success check
        if: ${{ steps.qa-review.outputs.approval == 'false' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          exit 1

      - name: QA not required
        id: qa-no-review
        if: ${{ env.NOQA == 'true' }}
        run: |
          echo "âœ… QA not required â€” skipping."

