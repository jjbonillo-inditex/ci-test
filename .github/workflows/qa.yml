name: Check QA Process

on:
  pull_request:
    types: [opened, reopened, labeled, unlabeled, synchronize]
  pull_request_review:
    types: [submitted, dismissed]

concurrency:
  group: qa-proccess-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  issues: write
  contents: read
env:
  QA: ${{ contains(github.event.pull_request.labels.*.name, 'qa') }}
  NOQA : ${{ contains(github.event.pull_request.labels.*.name, 'noqa') }}
jobs:
  detect_label:
    if: ${{ github.event_name == 'pull_request' }}
    name: üè∑Ô∏è Detect QA Label
    runs-on: ubuntu-latest
    steps:
      - name: Add reviewer to PR
        if: ${{ env.QA == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üë§ Adding reviewer to PR..."

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          REVIEWER=JuJoDevs

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/requested_reviewers" \
            -d "{\"reviewers\":[\"$REVIEWER\"]}"

          echo "‚úÖ Reviewer @$REVIEWER added to PR #$PR_NUMBER"

      - name: Comment on PR to trigger mobile deploy
        if: ${{ env.QA == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üí¨ Waiting 10s before commenting (in case a new job starts)..."
          sleep 5
          echo "üí¨ Commenting '/deploy-mobile' on PR..."

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
            -d '{"body":"/deploy-mobile"}'

          echo "‚úÖ Comment '/deploy-mobile' added to PR #$PR_NUMBER"

      - name: Skip QA and continue
        if: ${{ env.NOQA == 'true' }}
        run: echo "üö´ QA mode disabled ‚Äî continuing without QA verification"

      - name: Continue to QA Approval
        if: ${{ env.QA != 'true' && env.NOQA != 'true' }}
        run: |
          echo "‚û°Ô∏è No QA labels detected ‚Äî continuing to QA Approval step"
          exit 1

