name: QA Process Check

on:
  pull_request:
    types: [opened, reopened, labeled, unlabeled, synchronize]
  pull_request_review:
    types: [submitted, dismissed]

concurrency:
  group: qa-process-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  issues: write
  contents: read
  checks: write
  statuses: write

env:
  HAS_QA_LABEL: ${{ contains(github.event.pull_request.labels.*.name, 'qa') }}
  HAS_NOQA_LABEL: ${{ contains(github.event.pull_request.labels.*.name, 'noqa') }}
  QA_REVIEWER: "JuJoDevs"

jobs:
  validate-labels:
    name: üè∑Ô∏è Validate QA Labels
    runs-on: ubuntu-latest
    outputs:
      needs-qa: ${{ steps.check-labels.outputs.needs-qa }}
      skip-qa: ${{ steps.check-labels.outputs.skip-qa }}
      valid-labels: ${{ steps.check-labels.outputs.valid-labels }}
    steps:
      - name: Check label requirements
        id: check-labels
        run: |
          echo "QA Label: ${{ env.HAS_QA_LABEL }}"
          echo "NoQA Label: ${{ env.HAS_NOQA_LABEL }}"

          if [[ "${{ env.HAS_QA_LABEL }}" == "true" && "${{ env.HAS_NOQA_LABEL }}" == "true" ]]; then
            echo "‚ùå Cannot have both 'qa' and 'noqa' labels"
            echo "valid-labels=false" >> $GITHUB_OUTPUT
            exit 1
          elif [[ "${{ env.HAS_QA_LABEL }}" == "true" ]]; then
            echo "‚úÖ QA process required"
            echo "needs-qa=true" >> $GITHUB_OUTPUT
            echo "skip-qa=false" >> $GITHUB_OUTPUT
            echo "valid-labels=true" >> $GITHUB_OUTPUT
          elif [[ "${{ env.HAS_NOQA_LABEL }}" == "true" ]]; then
            echo "‚úÖ QA process skipped"
            echo "needs-qa=false" >> $GITHUB_OUTPUT
            echo "skip-qa=true" >> $GITHUB_OUTPUT
            echo "valid-labels=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå PR must have either 'qa' or 'noqa' label"
            echo "valid-labels=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  setup-qa:
    name: üöÄ Setup QA Process
    runs-on: ubuntu-latest
    needs: validate-labels
    if: needs.validate-labels.outputs.needs-qa == 'true' && github.event_name == 'pull_request'
    steps:
      - name: Add QA reviewer
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üë§ Adding reviewer to PR..."

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/requested_reviewers" \
            -d "{\"reviewers\":[\"${{ env.QA_REVIEWER }}\"]}" || true

          echo "‚úÖ Reviewer @${{ env.QA_REVIEWER }} added to PR #${{ github.event.pull_request.number }}"

      - name: Trigger mobile deployment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üí¨ Triggering mobile deployment..."
          sleep 5  # Brief delay to avoid race conditions

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            -d '{"body":"/deploy-mobile"}'

          echo "‚úÖ Mobile deployment triggered for PR #${{ github.event.pull_request.number }}"

  check-qa-approval:
    name: ‚úÖ Check QA Approval
    runs-on: ubuntu-latest
    needs: validate-labels
    if: needs.validate-labels.outputs.needs-qa == 'true'
    outputs:
      approved: ${{ steps.verify-approval.outputs.approved }}
    steps:
      - name: Verify QA approval
        id: verify-approval
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Checking QA approval status..."

          # Get all reviews for the PR
          reviews=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews")

          # Check the latest review state from QA reviewer
          last_state=$(echo "$reviews" | jq -r --arg reviewer "${{ env.QA_REVIEWER }}" \
            '[.[] | select(.user.login==$reviewer)][-1].state // "NONE"')

          echo "Last review state from @${{ env.QA_REVIEWER }}: $last_state"

          if [[ "$last_state" == "APPROVED" ]]; then
            echo "‚úÖ QA approved by @${{ env.QA_REVIEWER }}"
            echo "approved=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå QA approval required from @${{ env.QA_REVIEWER }}"
            echo "approved=false" >> $GITHUB_OUTPUT
          fi

      - name: Fail if not approved
        if: steps.verify-approval.outputs.approved == 'false'
        run: |
          echo "::error::QA approval required from @${{ env.QA_REVIEWER }}"
          exit 1

  qa-status:
    name: üìä QA Status Check
    runs-on: ubuntu-latest
    needs: [validate-labels, check-qa-approval]
    if: always()
    steps:
      - name: Update status check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîÑ Updating QA status check..."

          # Get commit SHA
          SHA="${{ github.event.after || github.event.pull_request.head.sha }}"

          # Determine status based on job results
          LABELS_VALID="${{ needs.validate-labels.outputs.valid-labels }}"
          NEEDS_QA="${{ needs.validate-labels.outputs.needs-qa }}"
          SKIP_QA="${{ needs.validate-labels.outputs.skip-qa }}"
          QA_APPROVED="${{ needs.check-qa-approval.outputs.approved }}"
          QA_JOB_RESULT="${{ needs.check-qa-approval.result }}"

          echo "Labels Valid: $LABELS_VALID"
          echo "Needs QA: $NEEDS_QA"
          echo "Skip QA: $SKIP_QA"
          echo "QA Approved: $QA_APPROVED"
          echo "QA Job Result: $QA_JOB_RESULT"

          # Determine final status
          if [[ "$LABELS_VALID" != "true" ]]; then
            STATUS="failure"
            DESCRIPTION="‚ùå Invalid label configuration"
          elif [[ "$SKIP_QA" == "true" ]]; then
            STATUS="success"
            DESCRIPTION="‚úÖ QA bypassed with 'noqa' label"
          elif [[ "$NEEDS_QA" == "true" ]]; then
            if [[ "$QA_APPROVED" == "true" ]]; then
              STATUS="success"
              DESCRIPTION="‚úÖ QA approved by @${{ env.QA_REVIEWER }}"
            else
              STATUS="failure"
              DESCRIPTION="‚ùå Waiting for QA approval from @${{ env.QA_REVIEWER }}"
            fi
          else
            STATUS="failure"
            DESCRIPTION="‚ùå Unknown state"
          fi

          echo "Final Status: $STATUS - $DESCRIPTION"

          # Update GitHub status
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/statuses/$SHA" \
            -d "{
              \"state\": \"$STATUS\",
              \"target_url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"description\": \"$DESCRIPTION\",
              \"context\": \"üîç review/qa-approval\"
            }"

          echo "‚úÖ Status check updated successfully"

          # Exit with error if status is failure
          if [[ "$STATUS" == "failure" ]]; then
            exit 1
          fi