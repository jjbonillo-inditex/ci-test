name: Check QA Process

on:
  pull_request:
    types: [opened, reopened, labeled, unlabeled, synchronize]
  pull_request_review:
    types: [submitted, dismissed]

concurrency:
  group: qa-proccess-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  issues: write
  contents: read
  checks: write
  statuses: write
env:
  QA: ${{ contains(github.event.pull_request.labels.*.name, 'qa') }}
  NOQA : ${{ contains(github.event.pull_request.labels.*.name, 'noqa') }}
jobs:
  detect_label:
    name: üè∑Ô∏è Detect QA Label
    runs-on: ubuntu-latest
    steps:
      - name: Add reviewer to PR
        if: ${{ env.QA == 'true' && github.event_name == 'pull_request' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üë§ Adding reviewer to PR..."

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          REVIEWER=JuJoDevs

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/requested_reviewers" \
            -d "{\"reviewers\":[\"$REVIEWER\"]}"

          echo "‚úÖ Reviewer @$REVIEWER added to PR #$PR_NUMBER"

      - name: Comment on PR to trigger mobile deploy
        if: ${{ env.QA == 'true' && github.event_name == 'pull_request' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üí¨ Waiting 10s before commenting (in case a new job starts)..."
          sleep 5
          echo "üí¨ Commenting '/deploy-mobile' on PR..."

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
            -d '{"body":"/deploy-mobile"}'

          echo "‚úÖ Comment '/deploy-mobile' added to PR #$PR_NUMBER"

      - name: Skip QA and continue
        if: ${{ env.NOQA == 'true' && github.event_name == 'pull_request' }}
        run: echo "üö´ QA mode disabled ‚Äî continuing without QA verification"

      - name: Continue to QA Approval
        if: ${{ github.event_name == 'pull_request_review' }}
        run: |
          echo "‚û°Ô∏è Pull Request Reviewed ‚Äî continuing to QA Approval step"

  qa-approval:
    name: QA approval
    runs-on: ubuntu-latest
    needs: detect_label
    steps:
      - name: Check QA approval status
        id: qa-review
        if: ${{ env.QA == 'true' }}
        run: |
          echo "üîç Checking if @jujodevs has approved..."
          reviews=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews")

          last_state=$(echo "$reviews" | jq -r '[.[] | select(.user.login=="JuJoDevs")][-1].state // "NONE"')
          echo "üß© Last state: $last_state"

          if [[ "$last_state" == "APPROVED" ]]; then
            echo "‚úÖ QA approval detected."
            echo "approval=true" >> $GITHUB_OUTPUT
          else
            echo "::error::‚ùå QA approval required from @jujodevs."
            echo "approval=false" >> $GITHUB_OUTPUT
          fi

      - name: Send approval success check
        if: ${{ steps.qa-review.outputs.approval == 'false' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          exit 1

      - name: QA not required
        id: qa-no-review
        if: ${{ env.NOQA == 'true' }}
        run: |
          echo "‚úÖ QA not required ‚Äî skipping."

      - name: Continue to QA Approval
        if: ${{ env.QA != 'true' && env.NOQA != 'true' }}
        run: |
          echo "‚û°Ô∏è No QA labels detected ‚Äî continuing to QA Approval step"
          exit 1

  # Status check job that GitHub can use as a required check
  qa-status-check:
    name: QA Status Check
    runs-on: ubuntu-latest
    needs: [detect_label, qa-approval]
    if: always() # Ensures this job runs regardless of previous job status
    steps:
      - name: Create or Update Status Check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Creating/Updating QA Status Check..."

          # Get PR information
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          # Use the latest commit SHA from the event
          SHA=${{ github.event.after || github.event.pull_request.head.sha }}

          echo "Using SHA: $SHA"

          # Check if QA label is present
          QA_LABEL="${{ env.QA }}"
          NOQA_LABEL="${{ env.NOQA }}"

          # Check the result of qa-approval job
          QA_APPROVAL_RESULT="${{ needs.qa-approval.result }}"

          echo "QA Label: $QA_LABEL"
          echo "NoQA Label: $NOQA_LABEL"
          echo "QA Approval Job Result: $QA_APPROVAL_RESULT"

          # Determine final status
          if [[ "$NOQA_LABEL" == "true" ]]; then
            STATUS="success"
            DESCRIPTION="‚úÖ QA bypassed with 'noqa' label"
            echo "$DESCRIPTION"
          elif [[ "$QA_LABEL" == "true" ]]; then
            if [[ "$QA_APPROVAL_RESULT" == "success" ]]; then
              STATUS="success"
              DESCRIPTION="‚úÖ QA approved by reviewer"
              echo "$DESCRIPTION"
            else
              STATUS="failure"
              DESCRIPTION="‚ùå QA required but not approved"
              echo "$DESCRIPTION"
            fi
          else
            STATUS="failure"
            DESCRIPTION="‚ùå PR requires either 'qa' or 'noqa' label"
            echo "$DESCRIPTION"
          fi

          # Create/Update the status check via API
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/statuses/$SHA" \
            -d "{
              \"state\": \"$STATUS\",
              \"target_url\": \"https://github.com/$REPO/actions/runs/${{ github.run_id }}\",
              \"description\": \"$DESCRIPTION\",
              \"context\": \"qa-process\"
            }"

          echo "‚úÖ Status check 'qa-process' updated with status: $STATUS"

          # Also set the job result
          if [[ "$STATUS" == "failure" ]]; then
            exit 1
          fi


