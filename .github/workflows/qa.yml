name: Check QA Process

on:
  pull_request:
    types: [opened, reopened, labeled, unlabeled, synchronize]
  pull_request_review:
    types: [submitted, dismissed]

concurrency:
  group: qa-proccess-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  issues: write
  contents: read
env:
  QA: ${{ contains(github.event.pull_request.labels.*.name, 'qa') }}
  NOQA : ${{ contains(github.event.pull_request.labels.*.name, 'noqa') }}
jobs:
  detect_label:
    if: ${{ github.event_name == 'pull_request' }}
    name: üè∑Ô∏è Detect QA Label
    runs-on: ubuntu-latest
    steps:
      - name: Add reviewer to PR
        if: ${{ env.QA == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üë§ Adding reviewer to PR..."

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          REVIEWER=JuJoDevs

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/requested_reviewers" \
            -d "{\"reviewers\":[\"$REVIEWER\"]}"

          echo "‚úÖ Reviewer @$REVIEWER added to PR #$PR_NUMBER"

      - name: Comment on PR to trigger mobile deploy
        if: ${{ env.QA == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üí¨ Waiting 10s before commenting (in case a new job starts)..."
          sleep 5
          echo "üí¨ Commenting '/deploy-mobile' on PR..."

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
            -d '{"body":"/deploy-mobile"}'

          echo "‚úÖ Comment '/deploy-mobile' added to PR #$PR_NUMBER"

      - name: Skip QA and continue
        if: ${{ env.NOQA == 'true' }}
        run: echo "üö´ QA mode disabled ‚Äî continuing without QA verification"

      - name: Continue to QA Approval
        if: ${{ env.QA != 'true' && env.NOQA != 'true' }}
        run: |
          echo "‚û°Ô∏è No QA labels detected ‚Äî continuing to QA Approval step"
          exit 1

  qa-approval:
    name: QA approval
    runs-on: ubuntu-latest
    needs: detect_label
    steps:
      - name: Create QA check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üß© Creating QA check..."
          gh api repos/${{ github.repository }}/check-runs \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            --input - <<EOF
            {
              "name": "QA Approval",
              "head_sha": "${{ github.event.pull_request.head.sha }}",
              "status": "in_progress",
              "output": {
                "title": "QA review in progress",
                "summary": "Waiting for QA approval result..."
              }
            }
          EOF

      - name: Check QA approval status
        id: qa-review
        if: ${{ env.QA == 'true' }}
        run: |
          echo "üîç Checking if @jujodevs has approved..."
          reviews=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews")

          last_state=$(echo "$reviews" | jq -r '[.[] | select(.user.login=="JuJoDevs")][-1].state // "NONE"')
          echo "üß© Last state: $last_state"

          if [[ "$last_state" == "APPROVED" ]]; then
            echo "‚úÖ QA approval detected."
            echo "approval=true" >> $GITHUB_OUTPUT
          else
            echo "::error::‚ùå QA approval required from @jujodevs."
            echo "approval=false" >> $GITHUB_OUTPUT
          fi

      - name: Send approval success check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api repos/${{ github.repository }}/check-runs \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            --input - <<EOF
            {
              "name": "QA Approval",
              "head_sha": "${{ steps.get_sha.outputs.sha }}",
              "status": "completed",
              "conclusion": "${{ needs.qa-approval.outputs.approval == 'true' && 'success' || 'failure' }}",
              "output": {
                "title": "${{ needs.qa-approval.outputs.approval == 'true' && 'QA Approved' || 'QA Approval Required' }}",
                "summary": "${{ needs.qa-approval.outputs.approval == 'true' && 'QA approval has been granted.' || 'QA approval is required from @jujodevs.' }}"
              }
            }
          EOF

