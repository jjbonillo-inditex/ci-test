name: Conditional QA Workflow

on:
  pull_request:
    types: [opened, reopened, labeled, unlabeled, synchronize]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  detect_label:
    name: üè∑Ô∏è Detect QA Label
    runs-on: ubuntu-latest
    outputs:
      qa_mode: ${{ steps.set_mode.outputs.qa_mode }}
    steps:
      - name: Determine QA mode
        id: set_mode
        run: |
          echo "üîç Checking labels on PR..."
      
          cat <<'EOF' > pr.json
          ${{ toJson(github.event.pull_request) }}
          EOF
      
          labels=$(jq -r '.labels[].name' pr.json 2>/dev/null || echo "")
      
          echo "Labels found: $labels"
      
          if echo "$labels" | grep -q "\bqa\b"; then
          echo "qa_mode=enabled" >> $GITHUB_OUTPUT
          echo "‚úÖ QA label detected"
          elif echo "$labels" | grep -q "\bnoqa\b"; then
          echo "qa_mode=disabled" >> $GITHUB_OUTPUT
          echo "üö´ NOQA label detected"
          else
          echo "qa_mode=none" >> $GITHUB_OUTPUT
          echo "::error::‚ùå No valid label found ‚Äî failing workflow."
          exit 1
          fi

  execute:
    name: üöÄ Execute Based on Label
    runs-on: ubuntu-latest
    needs: detect_label
    if: ${{ always() && needs.detect_label.result == 'success' }}
    steps:
      - name: Add reviewer to PR
        if: ${{ needs.detect_label.outputs.qa_mode == 'enabled' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üë§ Adding reviewer to PR..."
          
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          REVIEWER=JuJoDevs
          
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/requested_reviewers" \
            -d "{\"reviewers\":[\"$REVIEWER\"]}"
          
          echo "‚úÖ Reviewer @$REVIEWER added to PR #$PR_NUMBER"

      - name: Comment on PR to trigger mobile deploy
        if: ${{ needs.detect_label.outputs.qa_mode == 'enabled' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üí¨ Waiting 10s before commenting (in case a new job starts)..."
          sleep 5
          echo "üí¨ Commenting '/deploy-mobile' on PR..."
          
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
            -d '{"body":"/deploy-mobile"}'
          
          echo "‚úÖ Comment '/deploy-mobile' added to PR #$PR_NUMBER"

      - name: Skip QA and continue
        if: ${{ needs.detect_label.outputs.qa_mode == 'disabled' }}
        run: echo "üö´ QA mode disabled ‚Äî continuing without QA verification"
